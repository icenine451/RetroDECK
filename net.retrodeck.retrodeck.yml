app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: 5.15-21.08
#runtime-version: 6.3                        # bumped because of pcsx2-qt
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14    # Needed for rpcs3
  #- org.freedesktop.Sdk.Extension.dotnet6   # Needed for Ryujinx - Removed, check if it's not breaking something else
base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu
base-version: 5.15-21.08                    # Needed for Yuzu
command: retrodeck.sh

finish-args:
  - --socket=x11
  #- --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home # Needed to be able to relocate / remove / create symlink at ~/retrodeck
  - --filesystem=/run/media
  - --filesystem=/media
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
  # - --filesystem=home:ro # This may break Yuzu, let's see
  # - --filesystem=/run/media:ro
  # Dolphin
  - --allow=bluetooth
  #- --env=QT_QPA_PLATFORM=xcb #not sure if this will break something
  # rpcs3
  #- --socket=fallback-x11

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  #- /lib/debug
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
cleanup-commands:
  # Yuzu
  - /app/cleanup-BaseApp.sh

modules:

  - rd-submodules/shared-modules/libusb/libusb.json

  - name: chdman-tool
    buildsystem: simple
    build-commands:
      - cmake -B . -G Ninja
      - cmake --build .
      - cp chdman /app/bin
    sources:
      - type: git
        url: https://github.com/CharlesThobe/chdman.git
        commit: f7cadf1720cbeba8a14f2685830ff424a0c7f6cd

  - name: rclone
    buildsystem: simple
    build-commands:
      - cp rclone ${FLATPAK_DEST}/bin/
    sources:
      - type: archive
        url: https://github.com/rclone/rclone/releases/download/v1.61.1/rclone-v1.61.1-linux-amd64.zip
        sha256: 6d6455e1cb69eb0615a52cc046a296395e44d50c0f32627ba8590c677ddf50a9


    # External manifests end

  - name: retrodeck
    buildsystem: simple
    build-commands:

      # Initializing RO retrodeck config folder
      - mkdir -p ${FLATPAK_DEST}/retrodeck

      # Prep the ES-DE and RetroArch config files - I will have to SED/XMLSTARLET them soon
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_find_rules.xml
      - cp es-configs/es_find_rules.xml /app/share/emulationstation/resources/systems/unix/
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_systems.xml
      - cp es-configs/es_systems.xml /app/share/emulationstation/resources/systems/unix/
      # These must be put in home folder, managed by retrodeck.sh
      - cp es-configs/es_settings.xml ${FLATPAK_DEST}/retrodeck/es_settings.xml

      # Logo, res, move graphics directory away from default location so splash can be changed after build
      - mv -f -t ${FLATPAK_DEST}/retrodeck /app/share/emulationstation/resources/graphics
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash.svg
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash-orig.svg
      - cp -rf res/extra-splashes/ ${FLATPAK_DEST}/retrodeck/graphics
      - cp -f res/icon.svg /app/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.svg

      # Tools
      - mkdir -p ${FLATPAK_DEST}/retrodeck/tools/
      - cp tools/* ${FLATPAK_DEST}/retrodeck/tools/
      - mv -f es-configs/tools-gamelist.xml ${FLATPAK_DEST}/retrodeck/

      - cp retrodeck.sh /app/bin/retrodeck.sh
      - chmod +x /app/bin/retrodeck.sh

      # Function libraries
      - mkdir -p /app/libexec
      - cp global.sh /app/libexec/global.sh
      - cp functions.sh /app/libexec/functions.sh
      - cp post_update.sh /app/libexec/post_update.sh

      # Desktop entry
      - cp net.retrodeck.retrodeck.desktop /app/share/applications/net.retrodeck.retrodeck.desktop

      # TODO: group the configs per-emu and optimize the following cps, like already done with Dolphin. Please not that some files may be renamed, check retrodeck.sh to know how (and fix it after the edit)

      # Initializing default emulator configs
      - cp -r emu-configs ${FLATPAK_DEST}/retrodeck/emu-configs/

      # Overlays
      #- cp -r overlays ${FLATPAK_DEST}/retrodeck/overlays Disabled in 0.4.2b as it will be introduced in 0.5.0b

      # Placing appdata
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp net.retrodeck.retrodeck.appdata.xml ${FLATPAK_DEST}/share/appdata

    sources:
      - type: git
        url: https://github.com/XargonWan/RetroDECK.git
        branch: cooker-0.6.2b
