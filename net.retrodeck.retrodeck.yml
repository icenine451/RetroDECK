app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: 5.15-21.08
#runtime-version: 6.3                        # bumped because of pcsx2-qt
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14    # Needed for rpcs3
  #- org.freedesktop.Sdk.Extension.dotnet6   # Needed for Ryujinx - Removed, check if it's not breaking something else
base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu
base-version: 5.15-21.08                    # Needed for Yuzu
command: retrodeck.sh

finish-args:
  - --socket=x11
  #- --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home # Needed to be able to relocate / remove / create symlink at ~/retrodeck
  - --filesystem=/run/media
  - --filesystem=/media
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
  # - --filesystem=home:ro # This may break Yuzu, let's see
  # - --filesystem=/run/media:ro
  # Dolphin
  - --allow=bluetooth
  #- --env=QT_QPA_PLATFORM=xcb #not sure if this will break something
  # rpcs3
  #- --socket=fallback-x11

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  #- /lib/debug
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
cleanup-commands:
  # Yuzu
  - /app/cleanup-BaseApp.sh

modules:

  - name: chdman-tool
    enabled: false
    buildsystem: simple
    build-commands:
      - cmake -B . -G Ninja
      - cmake --build .
      - cp chdman /app/bin
    sources:
      - type: git
        url: https://github.com/CharlesThobe/chdman.git
        commit: f7cadf1720cbeba8a14f2685830ff424a0c7f6cd

  - name: rclone
    enabled: false
    buildsystem: simple
    build-commands:
      - cp rclone ${FLATPAK_DEST}/bin/
    sources:
      - type: archive
        url: https://github.com/rclone/rclone/releases/download/v1.61.1/rclone-v1.61.1-linux-amd64.zip
        sha256: 6d6455e1cb69eb0615a52cc046a296395e44d50c0f32627ba8590c677ddf50a9

  - name: rsync
    enabled: false
    buildsystem: simple
    build-commands:
      - ./configure --disable-md2man --disable-xxhash
      - make
      - cp rsync /app/bin
    sources:
      - type: git
        url: https://github.com/WayneD/rsync.git
        commit: 0698ea9aeb4044d615dc0ff2c6da24cea1bcc98e

  - name: vlc
    enabled: true
    buildsystem: simple
    build-commands:
      - ./configure
      - make
    sources:
      - type: archive
        url: https://get.videolan.org/vlc/3.0.18/vlc-3.0.18.tar.xz
        sha256: 57094439c365d8aa8b9b41fa3080cc0eef2befe6025bb5cef722accc625aedec

    # External manifests end

  - name: retrodeck
    buildsystem: simple
    build-commands:

      - mkdir -p ${FLATPAK_DEST}/retrodeck

      - cp retrodeck.sh /app/bin/retrodeck.sh
      - chmod +x /app/bin/retrodeck.sh

      # Function libraries
      - mkdir -p /app/libexec
      - cp global.sh /app/libexec/global.sh
      - cp functions.sh /app/libexec/functions.sh
      - cp post_update.sh /app/libexec/post_update.sh

      # Placing appdata
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp net.retrodeck.retrodeck.appdata.xml ${FLATPAK_DEST}/share/appdata

    sources:
      - type: git
        url: https://github.com/icenine451/RetroDECK.git
        branch: manifest-experiments
